{% load static %}
{% load form_tags %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--Link Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!--Link Iconos de Bootstrap-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <!--Link CSS-->
    <link rel="stylesheet" href="{% static 'css/autentication.css' %}">
    <title>Document</title>
</head>
<body>
    <div class="card p-4 form-contenedor" id="container">
        <h2 class="mb-3">Nueva contraseña</h2>
        <p>Ingrese su nueva contraseña.</p>
        {% if validlink %}
            <form method="post" id="passwordResetConfirmForm">
            {% csrf_token %}
            <div class="contenedor-input"> <!--Input contraseña-->
                <span class="icon-wrapper">
                    <i class="bi bi-lock toggle-lock " data-target="id_new_password1" style="cursor: pointer;"></i>
                    <i class="bi bi-unlock toggle-unlock d-none" data-target="id_new_password1" style="cursor:pointer;"></i>
                </span>
                {{ form.new_password1|add_class:"form"|attr:"placeholder=Contraseña"|attr:"required"|attr:"autocomplete=new-password" }}
            </div> <!--Input contraseña-->
            <div class="contenedor-input"> <!--Input repetir contraseña-->
                <span class="icon-wrapper">
                    <i class="bi bi-lock toggle-lock " data-target="id_new_password2" style="cursor: pointer;"></i>
                    <i class="bi bi-unlock toggle-unlock d-none" data-target="id_new_password2" style="cursor:pointer;"></i>
                </span>
                {{ form.new_password2|add_class:"form"|attr:"placeholder=Confirmar"|attr:"required"|attr:"autocomplete=new-password" }}
            </div> <!--Input repetir contraseña-->
            <!--Mensaje error en general-->
            {% if form.errors %}
                <div class="alert alert-danger d-flex align-items-start form" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.2rem;"></i>
                <ul class="mb-0">
                    {% for field in form %}
                    {% for error in field.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    {% endfor %}
                </ul>
                </div>
            {% endif %}
            <div id="passwordResetMessages"></div>
            <!--Mensaje error en general-->
            <button type="submit" class="btn" id="passwordResetConfirmLink">Guardar contraseña</button>
            </form>
            <div class="text-center mt-3 pregunta">
            <a href="{% url 'login' %}" class="text-decoration-none">Volver a Iniciar Sesión</a>
            </div>
        {% else %}
            <p class="text-danger text-center">El enlace no es válido o ya fue usado.</p>
            <div class="text-center mt-3">
            <a href="#" id="resetAgainLink" class="btn btn-warning">Solicitar otro enlace</a>
            </div>
        {% endif %}
    </div>
    <!--Modal-->
    <div class="modal fade" id="passwordConfirmModal" style="border-radius: 20px;" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="ModalPassword" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" id="modalContent">
                <!--COntenido de Model: en AJAX-->
            </div>
        </div>
    </div>
    <!--Modal-->
    <!--Link Jquery-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    <!--Link Js de Bootstrap-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <!--AJAX-->
<script>
document.addEventListener('DOMContentLoaded', function(){
    function attachTogglePassword() {
        document.querySelectorAll(".toggle-lock, .toggle-unlock").forEach(icon => {
            icon.addEventListener("click", () => {
                const targetId = icon.getAttribute("data-target");
                const input = document.getElementById(targetId);
                if (!input) return;

                const iconWrapper = icon.closest(".icon-wrapper");
                const lockIcon = iconWrapper.querySelector(".toggle-lock");
                const unlockIcon = iconWrapper.querySelector(".toggle-unlock");

                if (input.type === "password") {
                    input.type = "text";
                    lockIcon.classList.add("d-none");
                    unlockIcon.classList.remove("d-none");
                } else {
                    input.type = "password";
                    unlockIcon.classList.add("d-none");
                    lockIcon.classList.remove("d-none");
                }
            });
        });
    }

    function attachConfirmFormSubmit() {
        const form = document.querySelector('#passwordResetConfirmForm');
        if(!form) return;

        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        newForm.addEventListener('submit', function(e){
            e.preventDefault();
            const formData = new FormData(newForm);

            fetch(newForm.action || window.location.pathname, {
                method: 'POST',
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(resp => resp.json())
            .then(data => {
                const msgContainer = document.getElementById('passwordResetMessages');
                if(msgContainer) msgContainer.innerHTML = '';

                if(!data.success){
                    if(data.invalid_link){
                        if(msgContainer){
                            msgContainer.innerHTML = '<div class="alert alert-warning">El enlace no es válido o ya fue usado.</div>';
                        } else {
                            alert('El enlace no es válido o ya fue usado.');
                        }
                        return;
                    }

                    if(msgContainer && data.errors){
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger d-flex align-items-start';
                        let html = '<ul class="mb-0">';
                        for (const field in data.errors){
                            data.errors[field].forEach(msg => {
                                html += `<li>${msg}</li>`;
                            });
                        }
                        html += '</ul>';
                        alertDiv.innerHTML = html;
                        msgContainer.appendChild(alertDiv);
                    } else if(!msgContainer){
                        alert('Errores: ' + JSON.stringify(data.errors || data.message));
                    }
                    return;
                }

                if(data.success){
                    const modal = new bootstrap.Modal(document.getElementById('passwordConfirmModal'));
                    fetch("{% url 'password_reset_complete' %}")
                        .then(resp => resp.text())
                        .then(html => {
                            document.getElementById('modalContent').innerHTML = html;
                            modal.show();
                        });
                }
            })
            .catch(err => console.error(err));
        });

        attachTogglePassword();
    }

    function attachResetAgainLink() {
        const link = document.getElementById('resetAgainLink');
        if(!link) return;

        link.addEventListener('click', function(e){
            e.preventDefault();

            fetch("{% url 'password_reset' %}")
                .then(resp => resp.text())
                .then(html => {
                    const modal = new bootstrap.Modal(document.getElementById('passwordConfirmModal'));
                    document.getElementById('modalContent').innerHTML = html;
                    modal.show();

                    attachResetFormSubmit();
                })
                .catch(err => console.error(err));
        });
    }

    function attachResetFormSubmit() {
        const form = document.querySelector('#passwordResetForm');
        if(!form) return;

        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        newForm.addEventListener('submit', function(e){
            e.preventDefault();
            const formData = new FormData(newForm);

            fetch(newForm.action || window.location.pathname, {
                method: 'POST',
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(resp => resp.json())
            .then(data => {
                if(data.success){
                    fetch("{% url 'password_reset_done' %}")
                        .then(resp => resp.text())
                        .then(html => {
                            document.getElementById('modalContent').innerHTML = html;
                        });
                } else {
                    const msgContainer = document.getElementById('passwordResetMessages');
                    if(msgContainer) msgContainer.innerHTML = '';
                    if(data.errors && msgContainer){
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger d-flex align-items-start';
                        let html = '<ul class="mb-0">';
                        for (const field in data.errors){
                            data.errors[field].forEach(msg => html += `<li>${msg}</li>`);
                        }
                        html += '</ul>';
                        alertDiv.innerHTML = html;
                        msgContainer.appendChild(alertDiv);
                    }
                }
            })
            .catch(err => console.error(err));
        });

        attachTogglePassword();
    }

    attachTogglePassword();
    attachConfirmFormSubmit();
    attachResetAgainLink();

});
</script>
</body>
</html>